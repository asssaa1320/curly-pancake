name: Security Scanner

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      scan_type:
        description: 'Scan type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - pocsuite3_only
          - nucleifuzzer_only

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests
        pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pocsuite3
        
    - name: Clone NucleiFuzzer
      run: |
        git clone https://github.com/0xKayala/NucleiFuzzer.git || echo "NucleiFuzzer clone failed"
        
    - name: Run pocsuite3
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'pocsuite3_only' || github.event.inputs.scan_type == '' }}
      run: |
        echo "Starting pocsuite3 scan..."
        timeout 300 python -m pocsuite3 -u "${{ github.event.inputs.target_url }}" --format json --threads 10 > pocsuite3.json 2>&1 || true
        echo "pocsuite3 scan completed"
        
    - name: Run NucleiFuzzer
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'nucleifuzzer_only' }}
      run: |
        echo "Starting NucleiFuzzer scan..."
        if [ -d "NucleiFuzzer" ]; then
          cd NucleiFuzzer
          if [ -f "nucleifuzzer.py" ]; then
            timeout 600 python3 nucleifuzzer.py -u "${{ github.event.inputs.target_url }}" -o ../nucleifuzzer.json > ../nucleifuzzer.log 2>&1 || true
          else
            echo '{"status": "no_script", "message": "nucleifuzzer.py not found"}' > ../nucleifuzzer.json
          fi
          cd ..
        else
          echo '{"status": "not_cloned", "message": "NucleiFuzzer not available"}' > nucleifuzzer.json
        fi
        echo "NucleiFuzzer scan completed"
        
    - name: Create report
      run: |
        echo "# Security Scan Report" > report.md
        echo "" >> report.md
        echo "**Target:** ${{ github.event.inputs.target_url }}" >> report.md
        echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
        echo "**Scanner:** GitHub Actions" >> report.md
        echo "" >> report.md
        
        if [ -f "pocsuite3.json" ] && [ -s "pocsuite3.json" ]; then
          echo "## pocsuite3 Results" >> report.md
          echo "Status: Success" >> report.md
          echo "" >> report.md
        else
          echo "## pocsuite3 Results" >> report.md
          echo "Status: Failed" >> report.md
          echo "" >> report.md
        fi
        
        if [ -f "nucleifuzzer.json" ] && [ -s "nucleifuzzer.json" ]; then
          echo "## NucleiFuzzer Results" >> report.md
          echo "Status: Success" >> report.md
          echo "" >> report.md
        else
          echo "## NucleiFuzzer Results" >> report.md
          echo "Status: Failed" >> report.md
          echo "" >> report.md
        fi
        
        echo "## Summary" >> report.md
        echo "- pocsuite3: $([ -f "pocsuite3.json" ] && [ -s "pocsuite3.json" ] && echo "Success" || echo "Failed")" >> report.md
        echo "- NucleiFuzzer: $([ -f "nucleifuzzer.json" ] && [ -s "nucleifuzzer.json" ] && echo "Success" || echo "Failed")" >> report.md
        
    - name: Send to Telegram
      if: ${{ vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != '' }}
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        POCSUITE3_RESULT=$([ -f "pocsuite3.json" ] && [ -s "pocsuite3.json" ] && echo "Success" || echo "Failed")
        NUCLEIFUZZER_RESULT=$([ -f "nucleifuzzer.json" ] && [ -s "nucleifuzzer.json" ] && echo "Success" || echo "Failed")
        
        curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${CHAT_ID}\",
            \"text\": \"**Security Scan Complete**\\n\\n**Target:** ${{ github.event.inputs.target_url }}\\n**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')\\n\\n**Results:**\\n**pocsuite3:** ${POCSUITE3_RESULT}\\n**NucleiFuzzer:** ${NUCLEIFUZZER_RESULT}\\n\\n**Files:** Available in artifacts\",
            \"parse_mode\": \"Markdown\"
          }" || echo "Telegram notification failed"
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scan-results-${{ github.run_number }}
        path: |
          pocsuite3.json
          nucleifuzzer.json
          nucleifuzzer.log
          report.md
        retention-days: 30

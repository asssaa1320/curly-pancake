name: Security Scanner

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      scan_type:
        description: 'Scan type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - pocsuite3_only
          - nucleifuzzer_only
  schedule:
    - cron: '0 2 * * *'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Install pocsuite3
      run: |
        pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pocsuite3
        
    - name: Clone NucleiFuzzer
      run: |
        git clone https://github.com/0xKayala/NucleiFuzzer.git || echo "NucleiFuzzer clone failed, continuing..."
        
    - name: Run pocsuite3 scan
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'pocsuite3_only' || github.event.inputs.scan_type == '' }}
      run: |
        echo "Starting pocsuite3 scan on ${{ github.event.inputs.target_url }}"
        
        if command -v pocsuite3 &> /dev/null; then
          echo "Using pocsuite3 command..."
          timeout 300 pocsuite3 -u "${{ github.event.inputs.target_url }}" --format json --threads 10 > pocsuite3_results.json 2>&1 || echo "pocsuite3 command failed"
        else
          echo "Using python -m pocsuite3..."
          timeout 300 python -m pocsuite3 -u "${{ github.event.inputs.target_url }}" --format json --threads 10 > pocsuite3_results.json 2>&1 || echo "python -m pocsuite3 failed"
        fi
        
        echo "pocsuite3 scan completed"
        
    - name: Run NucleiFuzzer scan
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'nucleifuzzer_only' }}
      run: |
        echo "Starting NucleiFuzzer scan on ${{ github.event.inputs.target_url }}"
        
        if [ -d "NucleiFuzzer" ]; then
          cd NucleiFuzzer
          if [ -f "nucleifuzzer.py" ]; then
            echo "Found nucleifuzzer.py"
            timeout 600 python3 nucleifuzzer.py -u "${{ github.event.inputs.target_url }}" -o ../nucleifuzzer_results.json > ../nucleifuzzer_output.log 2>&1 || echo "nucleifuzzer.py failed"
          elif [ -f "main.py" ]; then
            echo "Found main.py"
            timeout 600 python3 main.py -u "${{ github.event.inputs.target_url }}" -o ../nucleifuzzer_results.json > ../nucleifuzzer_output.log 2>&1 || echo "main.py failed"
          else
            echo "No main script found in NucleiFuzzer"
            echo '{"status": "no_script_found", "message": "No executable script found"}' > ../nucleifuzzer_results.json
          fi
          cd ..
        else
          echo "NucleiFuzzer directory not found"
          echo '{"status": "not_cloned", "message": "NucleiFuzzer not available"}' > nucleifuzzer_results.json
        fi
        
        echo "NucleiFuzzer scan completed"
        
    - name: Create scan report
      run: |
        echo "Creating scan report..."
        
        echo "# Security Scan Report" > scan_report.md
        echo "" >> scan_report.md
        echo "**Target:** ${{ github.event.inputs.target_url }}" >> scan_report.md
        echo "**Scan Type:** ${{ github.event.inputs.scan_type || 'full' }}" >> scan_report.md
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> scan_report.md
        echo "**Scanner:** GitHub Actions" >> scan_report.md
        echo "" >> scan_report.md
        
        if [ -f "pocsuite3_results.json" ] && [ -s "pocsuite3_results.json" ]; then
          echo "## pocsuite3 Results" >> scan_report.md
          echo "" >> scan_report.md
          echo '```json' >> scan_report.md
          head -20 pocsuite3_results.json >> scan_report.md
          echo '```' >> scan_report.md
          echo "" >> scan_report.md
        else
          echo "## pocsuite3 Results" >> scan_report.md
          echo "" >> scan_report.md
          echo "Status: Failed or no results" >> scan_report.md
          echo "" >> scan_report.md
        fi
        
        if [ -f "nucleifuzzer_results.json" ] && [ -s "nucleifuzzer_results.json" ]; then
          echo "## NucleiFuzzer Results" >> scan_report.md
          echo "" >> scan_report.md
          echo '```json' >> scan_report.md
          head -20 nucleifuzzer_results.json >> scan_report.md
          echo '```' >> scan_report.md
          echo "" >> scan_report.md
        else
          echo "## NucleiFuzzer Results" >> scan_report.md
          echo "" >> scan_report.md
          echo "Status: Failed or no results" >> scan_report.md
          echo "" >> scan_report.md
        fi
        
        echo "## Summary" >> scan_report.md
        echo "" >> scan_report.md
        echo "- **pocsuite3:** $([ -f "pocsuite3_results.json" ] && [ -s "pocsuite3_results.json" ] && echo "Completed" || echo "Failed")" >> scan_report.md
        echo "- **NucleiFuzzer:** $([ -f "nucleifuzzer_results.json" ] && [ -s "nucleifuzzer_results.json" ] && echo "Completed" || echo "Failed")" >> scan_report.md
        echo "" >> scan_report.md
        
        echo "Report created successfully"
        
    - name: Send Telegram notification
      if: ${{ vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != '' }}
      env:
        BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Sending Telegram notification..."
        
        POCSUITE3_STATUS=$([ -f "pocsuite3_results.json" ] && [ -s "pocsuite3_results.json" ] && echo "Success" || echo "Failed")
        NUCLEIFUZZER_STATUS=$([ -f "nucleifuzzer_results.json" ] && [ -s "nucleifuzzer_results.json" ] && echo "Success" || echo "Failed")
        
        curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${CHAT_ID}\",
            \"text\": \"**Security Scan Report**\\n\\n**Target:** ${{ github.event.inputs.target_url }}\\n**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')\\n**Scanner:** GitHub Actions\\n\\n**Results:**\\n**pocsuite3:** ${POCSUITE3_STATUS}\\n**NucleiFuzzer:** ${NUCLEIFUZZER_STATUS}\\n\\n**Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\n**Report:** Available in artifacts\",
            \"parse_mode\": \"Markdown\"
          }" || echo "Failed to send Telegram message"
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-${{ github.run_number }}
        path: |
          pocsuite3_results.json
          nucleifuzzer_results.json
          nucleifuzzer_output.log
          scan_report.md
        retention-days: 30
        
    - name: Job summary
      if: always()
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Type:** ${{ github.event.inputs.scan_type || 'full' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results:" >> $GITHUB_STEP_SUMMARY
        echo "- **pocsuite3:** $([ -f "pocsuite3_results.json" ] && [ -s "pocsuite3_results.json" ] && echo "Success" || echo "Failed")" >> $GITHUB_STEP_SUMMARY
        echo "- **NucleiFuzzer:** $([ -f "nucleifuzzer_results.json" ] && [ -s "nucleifuzzer_results.json" ] && echo "Success" || echo "Failed")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files:" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

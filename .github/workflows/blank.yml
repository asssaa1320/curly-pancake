name: Security Scanner Workflow

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        type: string
      scan_type:
        description: 'Type of scan to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - pocsuite3_only
          - nucleifuzzer_only
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main, master ]
    paths:
      - 'scanner_workflow.py'
      - '.github/workflows/security-scan.yml'
      - 'requirements.txt'

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
        
    - name: Cache NucleiFuzzer
      uses: actions/cache@v3
      with:
        path: NucleiFuzzer
        key: ${{ runner.os }}-nucleifuzzer-${{ hashFiles('**/nucleifuzzer*') }}
        restore-keys: |
          ${{ runner.os }}-nucleifuzzer-
          
    - name: Clone NucleiFuzzer
      run: |
        if [ ! -d "NucleiFuzzer" ]; then
          git clone https://github.com/0xKayala/NucleiFuzzer.git
        else
          echo "NucleiFuzzer already cached"
        fi
        
    - name: Install additional tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl wget jq
        
    - name: Determine target URL
      id: target
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "url=${{ github.event.inputs.target_url }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          # Use default target for scheduled runs (can be modified)
          echo "url=https://httpbin.org" >> $GITHUB_OUTPUT
        else
          # Use default target for push events
          echo "url=https://httpbin.org" >> $GITHUB_OUTPUT
        fi
        
    - name: Run pocsuite3 scan
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'pocsuite3_only' || github.event.inputs.scan_type == '' }}
      id: pocsuite3-scan
      run: |
        echo "Starting pocsuite3 scan on ${{ steps.target.outputs.url }}"
        
        # Run pocsuite3 with timeout
        timeout 300 python -m pocsuite3 -u "${{ steps.target.outputs.url }}" --format json --threads 10 > pocsuite3_results.json 2>&1 || true
        
        # Check if results file exists and has content
        if [ -s "pocsuite3_results.json" ]; then
          echo "pocsuite3 scan completed"
          echo "pocsuite3_success=true" >> $GITHUB_OUTPUT
        else
          echo "pocsuite3 scan failed or no results"
          echo "pocsuite3_success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Run NucleiFuzzer scan
      if: ${{ github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'nucleifuzzer_only' }}
      id: nucleifuzzer-scan
      run: |
        echo "Starting NucleiFuzzer scan on ${{ steps.target.outputs.url }}"
        
        # Change to NucleiFuzzer directory
        cd NucleiFuzzer
        
        # Run NucleiFuzzer with timeout
        timeout 600 python3 nucleifuzzer.py -u "${{ steps.target.outputs.url }}" -o ../nucleifuzzer_results.json > ../nucleifuzzer_output.log 2>&1 || true
        
        # Go back to root directory
        cd ..
        
        # Check if results file exists and has content
        if [ -s "nucleifuzzer_results.json" ]; then
          echo "NucleiFuzzer scan completed"
          echo "nucleifuzzer_success=true" >> $GITHUB_OUTPUT
        else
          echo "NucleiFuzzer scan failed or no results"
          echo "nucleifuzzer_success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Process scan results
      id: results
      run: |
        echo "Processing scan results..."
        
        # Create results summary
        echo "# Security Scan Report" > scan_report.md
        echo "" >> scan_report.md
        echo "**Target:** ${{ steps.target.outputs.url }}" >> scan_report.md
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> scan_report.md
        echo "**Scan Type:** ${{ github.event.inputs.scan_type || 'full' }}" >> scan_report.md
        echo "" >> scan_report.md
        
        # Process pocsuite3 results
        if [ "${{ steps.pocsuite3-scan.outputs.pocsuite3_success }}" = "true" ]; then
          echo "## pocsuite3 Results" >> scan_report.md
          echo '```json' >> scan_report.md
          cat pocsuite3_results.json | head -50 >> scan_report.md
          echo '```' >> scan_report.md
          echo "" >> scan_report.md
        else
          echo "## pocsuite3 Results" >> scan_report.md
          echo "Scan failed or no vulnerabilities found" >> scan_report.md
          echo "" >> scan_report.md
        fi
        
        # Process NucleiFuzzer results
        if [ "${{ steps.nucleifuzzer-scan.outputs.nucleifuzzer_success }}" = "true" ]; then
          echo "## NucleiFuzzer Results" >> scan_report.md
          echo '```json' >> scan_report.md
          cat nucleifuzzer_results.json | head -50 >> scan_report.md
          echo '```' >> scan_report.md
          echo "" >> scan_report.md
        else
          echo "## NucleiFuzzer Results" >> scan_report.md
          echo "Scan failed or no results" >> scan_report.md
          echo "" >> scan_report.md
        fi
        
        # Create summary for GitHub
        echo "## Summary" >> scan_report.md
        echo "- **pocsuite3:** ${{ steps.pocsuite3-scan.outputs.pocsuite3_success == 'true' && 'Success' || 'Failed' }}" >> scan_report.md
        echo "- **NucleiFuzzer:** ${{ steps.nucleifuzzer-scan.outputs.nucleifuzzer_success == 'true' && 'Success' || 'Failed' }}" >> scan_report.md
        
        # Set output for summary
        SCAN_SUMMARY="Scan completed for ${{ steps.target.outputs.url }}"
        echo "summary=$SCAN_SUMMARY" >> $GITHUB_OUTPUT
        
    - name: Send results to Telegram
      if: ${{ vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != '' }}
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "Sending results to Telegram..."
        
        # Prepare Telegram message
        TELEGRAM_MESSAGE="**Security Scan Report**
        
        **Target:** ${{ steps.target.outputs.url }}
        **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        **Scanner:** GitHub Actions
        
        **Results:**
        **pocsuite3:** ${{ steps.pocsuite3-scan.outputs.pocsuite3_success == 'true' && 'Completed' || 'Failed' }}
        **NucleiFuzzer:** ${{ steps.nucleifuzzer-scan.outputs.nucleifuzzer_success == 'true' && 'Completed' || 'Failed' }}
        
        **Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        **Full Report:** Available in workflow artifacts"
        
        # Send message to Telegram
        curl -X POST \
          "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$TELEGRAM_MESSAGE\",
            \"parse_mode\": \"Markdown\"
          }"
        
    - name: Upload scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-scan-results-${{ github.run_number }}
        path: |
          pocsuite3_results.json
          nucleifuzzer_results.json
          nucleifuzzer_output.log
          scan_report.md
        retention-days: 30
        
    - name: Create job summary
      if: always()
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target URL:** ${{ steps.target.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Type:** ${{ github.event.inputs.scan_type || 'full' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results:" >> $GITHUB_STEP_SUMMARY
        echo "- **pocsuite3:** ${{ steps.pocsuite3-scan.outputs.pocsuite3_success == 'true' && 'Success' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **NucleiFuzzer:** ${{ steps.nucleifuzzer-scan.outputs.nucleifuzzer_success == 'true' && 'Success' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- [Scan Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [Download Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        
  notification:
    runs-on: ubuntu-latest
    needs: security-scan
    if: always() && (vars.TELEGRAM_BOT_TOKEN != '' && vars.TELEGRAM_CHAT_ID != '')
    
    steps:
    - name: Send final notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ "${{ needs.security-scan.result }}" = "success" ]; then
          STATUS="Success"
        else
          STATUS="Failed"
        fi
        
        FINAL_MESSAGE="**Security Scan Complete**
        
        $STATUS
        
        **Repository:** ${{ github.repository }}
        **Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        **Triggered by:** ${{ github.actor }}
        
        **Results available in workflow artifacts**"
        
        curl -X POST \
          "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$FINAL_MESSAGE\",
            \"parse_mode\": \"Markdown\"
          }"

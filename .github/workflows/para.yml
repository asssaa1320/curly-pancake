name: Parameter Scanner with ParamSpider

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target domain to scan (e.g., example.com)'
        required: true
        type: string
      depth:
        description: 'Depth of crawling (default: 1)'
        required: false
        default: '1'
        type: string

jobs:
  paramspider-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git python3-pip
        # Clone ParamSpider repository
        git clone https://github.com/devanshbatham/ParamSpider
        cd ParamSpider
        # Install required packages
        pip3 install requests urllib3 bs4 argparse
        # Install additional required packages
        pip3 install requests

    - name: Run ParamSpider
      id: paramspider
      run: |
        cd ParamSpider
        python3 paramspider.py -d ${{ github.event.inputs.target }} --level ${{ github.event.inputs.depth }} -o /tmp/paramspider_output.txt
        
        if [ -s "/tmp/paramspider_output.txt" ]; then
          echo "paramspider_output=$(cat /tmp/paramspider_output.txt | base64 -w 0)" >> $GITHUB_OUTPUT
        else
          echo "No parameters found"
          echo "paramspider_output=No parameters found" >> $GITHUB_OUTPUT
        fi

    - name: Test for vulnerabilities
      id: test_vulns
      run: |
        echo "${{ steps.paramspider.outputs.paramspider_output }}" | base64 -d > params.txt
        
        if [ -s "params.txt" ]; then
          echo "Running vulnerability tests..."
          echo -e "\n=== Potential XSS Vulnerabilities ===" > results.txt
          grep -i "\(<\|>\|alert(" params.txt | head -n 20 >> results.txt
          
          echo -e "\n=== Potential LFI Parameters ===" >> results.txt
          grep -i "\(file\|path\|page\|include\)=" params.txt | head -n 20 >> results.txt
          
          echo -e "\n=== Potential Open Redirect Parameters ===" >> results.txt
          grep -i "\(url\|redirect\|next\|r\|u\|dest\|destination\|redir\)=" params.txt | head -n 20 >> results.txt
          
          echo "results=$(cat results.txt | base64 -w 0)" >> $GITHUB_OUTPUT
        else
          echo "No parameters to test"
          echo "results=No parameters found to test" >> $GITHUB_OUTPUT
        fi

    - name: Send results to Telegram
      if: always()
      run: |
        MESSAGE="*üîç Parameter Scan Results*\n"
        MESSAGE+="*Target:* ${{ github.event.inputs.target }}\n"
        MESSAGE+="*Status:* ${{ job.status }}\n\n"
        
        if [ "${{ steps.test_vulns.outputs.results }}" != "" ]; then
          RESULTS=$(echo "${{ steps.test_vulns.outputs.results }}" | base64 -d)
          MESSAGE+="*Scan Results:*\n\`\`\`\n$RESULTS\n\`\`\`"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown"

    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: paramspider-results
        path: |
          params.txt
          results.txt
        retention-days: 1
